on: [workflow_dispatch]
name: Deploy Bicep
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      SubscriptionId: "d5613b48-e2b5-4bcb-81cb-fe54af28b8cd"
      ResourceGroupName: "bicep-and-github"
      ResourceGroupLocation: "northeurope"
    
    steps:

      # Checkout code
    - name: Checkout
      uses: actions/checkout@main

      # Log into Azure
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Create the target Resource Group
    - name: Create Resource Group
      uses: Azure/CLI@v1
      with:
        inlineScript: |
          #!/bin/bash
          az group create --name ${{ env.ResourceGroupName }} --location ${{ env.ResourceGroupLocation }}
          echo "Azure resource group created"

      # Deploy Bicep file
    - name: Deploy
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ env.SubscriptionId }}
        resourceGroupName: ${{ env.ResourceGroupName }}
        template: ./third-sample.bicep
        parameters: 'resourcesPrefix=${{ vars.RESOURCESPREFIX }}'
        failOnStdErr: false

      # Echo output variables, just for the sake of it        
    - run: echo ${{ steps.Deploy.outputs.azureServiceBusNamespace }}

    - run: echo ${{ steps.Deploy.outputs.functionAppName }}
    
      # Create the Managed Identity for the Function App
    - name: Configure Managed Identity
      uses: azure/CLI@v1
      with:
        azcliversion: 2.47.0
        inlineScript: |
          $sbNamespaceId = (az servicebus namespace show --resource-group ${{ secrets.AZURE_RG }} --name  ${{ steps.Deploy.outputs.azureServiceBusNamespace }} --query id --output tsv)
          $miFunctionAppPrincipalId = (az functionapp identity assign -g ${{ secrets.AZURE_RG }} -n ${{ steps.Deploy.outputs.functionAppName }} --query principalId --output tsv)
          az role assignment create --assignee $miFunctionAppPrincipalId --role "Azure Service Bus Data Sender" --scope $sbNamespaceId
